name: üèóÔ∏è –°–±–æ—Ä–∫–∞ .exe –∏ –≤—ã–ø—É—Å–∫

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞ –≤–∏–¥–∞ v*
on:
  push:
    tags:
      - 'v*'
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-exe:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.11']

    steps:
      - name: üîπ Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: üîπ –ß—Ç–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞ VERSION
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=v$VERSION" >> $GITHUB_ENV
        shell: bash

      - name: üîπ –õ–æ–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏
        run: |
          echo "üîÑ –°–±–æ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏: ${{ env.RELEASE_VERSION }}"
          echo "üè∑  –¢–µ–≥: ${{ env.TAG_NAME }}"

      - name: üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        timeout-minutes: 10
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -e .
          pip install --no-cache-dir PyQt6 pyinstaller toml

      - name: üîπ –°–±–æ—Ä–∫–∞ .exe —Å –ø–æ–º–æ—â—å—é PyInstaller
        run: |
          python -m PyInstaller   --noconsole   --onefile   --name "ConverterCSVtoRDF"   --add-data "config.json;."   --distpath "dist"   src/ui.py

      - name: üîπ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø–∞–ø–∫–∏
        run: |
          mkdir dist/final
          Copy-Item -Path "config.json" -Destination "dist/final/config.json"
          Copy-Item -Path "dist/ConverterCSVtoRDF.exe" -Destination "dist/final/ConverterCSVtoRDF.exe"
        shell: pwsh

      - name: üîπ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞
        run: |
          cd dist/final
          Compress-Archive -Path * -DestinationPath ../converter-package.zip
        shell: pwsh

      - name: üîπ –ò–∑–≤–ª–µ—á—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –≤–µ—Ä—Å–∏–∏ –∏–∑ CHANGELOG.md
        id: changelog
        run: |
          $version = "${{ env.RELEASE_VERSION }}"

          if (-not (Test-Path "CHANGELOG.md")) {
            echo "‚ö†Ô∏è  –§–∞–π–ª CHANGELOG.md –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "CHANGELOG_BLOCK=–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞." >> $env:GITHUB_ENV
            exit 0
          }

          $content = Get-Content -Path CHANGELOG.md -Raw -Encoding UTF8
          $regex = "(?s)(?<=## \[$version\][^\n]*\n)(.*?)(?=\n## |\Z)"
          $match = [regex]::Match($content, $regex)

          if ($match.Success) {
            $changes = $match.Value.Trim()
          } else {
            $changes = "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –≤–µ—Ä—Å–∏–∏ $version –Ω–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã."
          }

          if ([string]::IsNullOrWhiteSpace($changes)) {
            $changes = "–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω—ã."
          }

          # –û—Ç—Å—Ç—É–ø –¥–ª—è YAML
          $changes = $changes -replace '^', '            '
          echo "CHANGELOG_BLOCK=$changes" >> $env:GITHUB_ENV
        shell: pwsh

      - name: üîπ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ –Ω–∞ GitHub
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: –í—ã–ø—É—Å–∫ ${{ env.TAG_NAME }}
          body: |
            ## üöÄ –í—ã–ø—É—Å–∫ ${{ env.TAG_NAME }}

            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±—Ä–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä CSV ‚Üí RDF/XML**.

            ### üì¶ –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ
            - `ConverterCSVtoRDF.exe` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
            - `config.json` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ)

            ### üìù –ß—Ç–æ –Ω–æ–≤–æ–≥–æ
            ${{ env.CHANGELOG_BLOCK }}

            ### üß∞ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
            1. –°–∫–∞—á–∞–π—Ç–µ `converter-package.zip`
            2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –≤ –ª—é–±—É—é –ø–∞–ø–∫—É
            3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `ConverterCSVtoRDF.exe`
            4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `config.json` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º —Å `.exe`

            –í–µ—Ä—Å–∏—è: ${{ env.RELEASE_VERSION }}
          draft: false
          prerelease: false
          files: dist/converter-package.zip
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
